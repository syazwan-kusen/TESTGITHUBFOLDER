@using Newtonsoft.Json;
@using myvdbsSQL;
@using MyVDBSDemo.Models;
@using System.Configuration;
@model IEnumerable<MyVDBSDemo.Models.tblVulProject>
    @using MVCEncrypt;


    @{
    ViewBag.Title = "Vulnerability Project List";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    }

    }

    <div class="col-lg-12" style="margin-top:80px">
        <div class="panel panel-info">
            <div class="panel-body">
                <table class="table table-bordered table-striped display" id="pageList" align="center">
                    <thead style="background-color:moccasin">
                        <tr>
                            <th class="text-center">No.</th>
                            <th class="text-center">Project Name</th>
                            <th class="text-center">Client Info</th>
                            <th class="text-center"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                        var count = 0;
                        foreach (var item in Model)

                        {
                        count = count + 1;
                        <tr>
                            <td style="text-align:center">@count</td>
                            <td>@Html.Raw(item.VulProjectName)</td>
                            <td>@Html.Raw(item.a.VulProjClientName)</td>
                            <td style="text-align:center">
                                <a class="btn btn-primary btn-xs find" href='@Url.ActionEnc("mySecret", "FindingList", new { a = item.VulProjectId })'><i class="glyphicon glyphicon-search"></i> Finding</a>

                                @*<button type="button" id="finding" class="btn btn-primary btn-xs find" onclick="find()"><span class="glyphicon glyphicon-search"></span> Finding</button>*@
                                <a class="btn btn-success btn-xs edit" href='@Url.ActionEnc("mySecret", "VulnerabilityProjectListUpdate", new { a = item.VulProjectId })'><i class="glyphicon glyphicon-pencil"></i> Update</a>
                                @*<a class="btn btn-success btn-xs edit" href="/Superadmin/VulnerabilityProjectListUpdate/@item.DREADRiskId">Update<span class="glyphicon glyphicon-pencil"></span></a>
                                <button type="button" id="edit" class="btn btn-success btn-xs edit" onclick="edit('@item.DREADRiskId')"><span class="glyphicon glyphicon-pencil"></span> Update</button>*@
                                <button type="button" id="delete" class="btn btn-danger btn-xs delete" onclick="hapus('@item.VulProjectId')"><span class="glyphicon glyphicon-trash"></span> Delete</button>

                                <button type="button" id="openreport" class="btn btn-primary btn-xs" onclick="Print('@item.VulProjectId')">
                                    <span class="fa fa-print" aria-hidden="true"></span> Print Preview
                                </button>
                            </td>
                        </tr>
                        }
                        }
                    </tbody>
                </table>
                <div align="right">
                    <div id="drawSearchPaginateDT"></div>
                </div>
                <div class="row">
                    <div class="col-md-12" align="center">

                        @*<button data-bind="click : add, visible :true, enable: true" class="btn btn-primary btn-sm m-t-10">
                            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Add
                        </button>*@
                        <a class="btn btn-primary btn-sm" href="/Admin/VulnerabilityProjectListAdd"><i class="glyphicon glyphicon-plus"></i> Add</a>



                        @*<button data-bind="click : cancel, visible :true, enable: true" class="btn btn-info btn-sm m-t-10">
                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Cancel
                        </button>*@

                    </div>
                </div>
            </div>

        </div>
    </div>

<script src="~/Scripts/Common/CookieHelper.js"></script>
    <script>

    var Rating = @Html.Raw(JsonConvert.SerializeObject(@Model, Formatting.None,
                    new JsonSerializerSettings()
        {
            ReferenceLoopHandling = ReferenceLoopHandling.Ignore
        }));


    var reportserver ='@ConfigurationManager.AppSettings["ReportServer"]';

    </script>

    <script>
    var dtInstance = $("#pageList").DataTable({
        "scrollCollapse": false,
        "paging": true,
        "columnDefs": [{
            "searchable": false,
            "orderable": false,
            "targets": 0
        }],
        "order": [[1, 'asc']]
    });

    dtInstance.on('order.dt search.dt', function () {
        dtInstance.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
            cell.innerHTML = i + 1;
        });
    }).draw();

    dtInstance.on( 'draw', function () {
        $('#paginatesearch').val(dtInstance.page()+1);
        setCookie("listingpage17", dtInstance.page()+1, 1);
    } );

    var viewModel;
    var UserIdLogin = '@User.Identity.Name';

    var btnRefresh = function () {
        location.reload();
    }

    $(function () {

        viewModel = {
            rating1: ko.mapping.fromJS(Rating),
            rating2 :
            {
                DREADRiskId: ko.observable(""),
                SeverityNm: ko.observable(""),
                RiskMin: ko.observable(""),
                RiskMax: ko.observable(""),
                UserIdLogin: UserIdLogin,
            },

            remove: function(VulProjectId) {
                ShowDecisionMessage("Are you sure to delete this record ? ", function () {

                    var btnOk = function () {

                    }
                    $.ajax({
                        type: "POST",
                        url: server + "/Vulnerability/DeleteVulProject",
                        data: JSON.stringify({ VulProjectId: VulProjectId }),
                        contentType: "application/json; charset=utf-8",
                        error: function (xhr) { },
                        success: function (msg) {
                            if (msg.OK) {
                                ShowMessageSuccess("Record successfully deleted.", btnRefresh);
                            }
                            else {
                                ShowMessageDanger('Unsuccesfully deleted.');
                            }
                        }
                    })

                });
            },


        }

        ko.applyBindings(viewModel);
    });

    function hapus (VulProjectId) {
        viewModel.remove(VulProjectId);
    }

    function Print(VulProjectId) {

        ReportPath = "VulProject";
        strRptName = "VulProjMainRpt";
        ReportTitle = "Vulnerability Project Main Report";

        //   RL = server + "/Report/URL_ReportsLauncher.aspx?"
        //  http://atm-dev//ReportServer?/LeaveReports/rptLeaveApp&intLvAppId=2466645&strLvTypeCd=L0101&rs:Command=Render
        //RL = reportserver+"/ReportServer?"+"/"+ReportPath+"/"+strRptName+"&intLvAppId="+viewModel.selectLvappId()+"&strLvTypeCd="+viewModel.lvTypeCd();
        RL = reportserver+"/ReportServer?"+"/"+ReportPath+"/"+strRptName+"&VulProjectId="+VulProjectId;

        //params = params + "&ReportPath=" + ReportPath;
        //params = params + "&ReportName=" + strRptName;
        //params = params + "&ReportTitle=" + ReportTitle;
        //params = params + "&intLvAppId=" + viewModel.selectLvappId();
        //params = params + "&strLvTypeCd=" + viewModel.lvTypeCd();
             
             
        //fullPath = RL + params;
        fullPath = RL;
        strStyle = "toolbar=no,menubar=no,location=no,scrollbars=no,resizable=yes,width=950,height=650,top=10,left=600";
        blnWindowReplace = true;
        window.open(fullPath, '_blank','noopener');

    }
        

    function drawSearchPaginateDT() {

        var searchPaginateDT = "<div id='hidesearch'> Page <input type='text' size='4'  id='paginatesearch' value ='1' onchange='searchPaginateList(this.value)' autocomplete='off'></input></div>";

        $("#drawSearchPaginateDT").html(searchPaginateDT);
    }

    function searchPaginateList(pageNum) {
        var lastPage = $('#pageList').DataTable().page.info().pages;

        if(pageNum > lastPage)
            pageNum = lastPage;

        $('#paginatesearch').val(pageNum);

        var pageIndex = pageNum - 1;
        $('#pageList').DataTable().page(pageIndex).draw('page')

    }
    
    //var table = $('#pageList').DataTable();
 
    //table.on( 'draw', function () {
    //    $('#paginatesearch').val(table.page()+1);
    //    setCookie("listingpage17", table.page()+1, 1);
    //} );
    
    $(document).ready(function(){
        drawSearchPaginateDT();
        checkListingPageCookie2("listingpage17");
    });
    </script>
